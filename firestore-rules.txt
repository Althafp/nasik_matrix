rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - allow sign up (create) without authentication
    match /users/{userId} {
      // Allow anyone to create a new user (sign up) - no auth required
      // Validate that required fields are present and correct type
      allow create: if request.resource.data.keys().hasAll(['phoneNumber', 'password'])
                    && request.resource.data.phoneNumber is string
                    && request.resource.data.password is string
                    && request.resource.data.phoneNumber.size() > 0
                    && request.resource.data.password.size() > 0;
      
      // Allow anyone to read user documents (needed for login check)
      // In production, you might want to restrict this
      allow read: if true;
      
      // Allow update only if userId in data matches the document ID
      // This prevents users from updating other users' data
      allow update: if request.resource.data.userId == userId
                    || resource.data.phoneNumber == request.resource.data.phoneNumber;
      
      // No delete for users (prevent accidental deletion)
      allow delete: if false;
      
      // Surveys subcollection - allow read/write for all (since we check auth in app)
      // For better security, you could add userId validation here too
      match /surveys/{surveyId} {
        // Allow create - validate userId matches
        allow create: if request.resource.data.userId == userId;
        
        // Allow read - users can read their own surveys
        // For collection group queries, we need to allow reads from any path
        // Admin check is done in app code before calling getAllSurveys()
        // Collection group queries access documents via collectionGroup('surveys')
        // so we need to allow reads from any surveys collection
        allow read: if true; // Allow reads (admin check in app code)
        
        // Allow update - users can update their own surveys
        allow update: if resource.data.userId == userId
                      && request.resource.data.userId == userId;
        
        // Allow delete - users can delete their own surveys
        allow delete: if resource.data.userId == userId;
      }
      
      // Surveys2 subcollection - same rules as surveys
      match /surveys2/{surveyId} {
        // Allow create - validate userId matches
        allow create: if request.resource.data.userId == userId;
        
        // Allow read - users can read their own surveys
        // For collection group queries, we need to allow reads from any path
        // Admin check is done in app code before calling getAllSurveys()
        // Collection group queries access documents via collectionGroup('surveys2')
        // so we need to allow reads from any surveys2 collection
        allow read: if true; // Allow reads (admin check in app code)
        
        // Allow update - users can update their own surveys
        allow update: if resource.data.userId == userId
                      && request.resource.data.userId == userId;
        
        // Allow delete - users can delete their own surveys
        allow delete: if resource.data.userId == userId;
      }
    }
    
    // Allow collection group queries for surveys
    // This is needed for admin to query all surveys across all users
    // Collection group queries match any path ending with /surveys/{surveyId}
    match /{path=**}/surveys/{surveyId} {
      // Allow read for collection group queries
      // Admin check is done in app code
      allow read: if true;
    }
    
    // Allow collection group queries for surveys2
    // This is needed for admin to query all surveys2 across all users
    // Collection group queries match any path ending with /surveys2/{surveyId}
    match /{path=**}/surveys2/{surveyId} {
      // Allow read for collection group queries
      // Admin check is done in app code
      allow read: if true;
    }
    
    // Deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
